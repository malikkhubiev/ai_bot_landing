# Спецификация системы отслеживания пользователей

## Обзор
Система отслеживает действия пользователей на лендинге и отправляет данные в Google Form для анализа поведения.

## Структура данных

### 1. startTime (entry.1021556296)
- **Тип:** ISO 8601 строка времени
- **Описание:** Время первого захода пользователя на страницу
- **Пример:** `2025-07-28T16:07:44.807Z`
- **Формат:** UTC время в формате ISO 8601

### 2. endTime (entry.1723535016)
- **Тип:** ISO 8601 строка времени
- **Описание:** Время ухода пользователя со страницы (закрытие вкладки, переход на другую страницу)
- **Пример:** `2025-07-28T16:07:45.578Z`
- **Примечание:** Может отправляться несколько раз за сессию при различных событиях (blur, beforeunload, pagehide)

### 3. duration (entry.185158797)
- **Тип:** Целое число (секунды)
- **Описание:** Общее время, проведенное на странице
- **Пример:** `1`, `3`, `45`
- **Расчет:** `Math.round((endTime - startTime) / 1000)`

### 4. clickEvent (entry.834430057)
- **Тип:** JSON-массив объектов
- **Описание:** События кликов по важным элементам страницы (все клики за сессию в одной строке)
- **Структура объекта:**
  ```json
  {
    "type": "telegram|faq|navigation|price_button",
    "time": "2025-07-28T16:07:48.811Z",
    "text": "Текст кнопки/ссылки"
  }
  ```
- **Возможные типы:**
  - `"telegram"` - клик по ссылке на Telegram-бота
  - `"faq"` - клик по элементам FAQ (раскрытие/скрытие вопросов)
  - `"navigation"` - клик по навигационным ссылкам (О курсе, Преимущества, Программа)
  - `"price_button"` - клик по кнопке "Купить курс" в навигации
- **Примеры:**
  - `[]` - пустой массив (нет кликов)
  - `[{"type":"telegram","time":"...","text":"Купить через Telegram"}]` - только клик по Telegram
  - `[{"type":"faq","time":"...","text":"Нужно ли знать математику?"},{"type":"telegram","time":"...","text":"Купить через Telegram"}]` - клик по FAQ + Telegram
  - `[{"type":"navigation","time":"...","text":"О курсе"},{"type":"faq","time":"...","text":"Как проходит обучение?"},{"type":"telegram","time":"...","text":"Купить через Telegram"}]` - полная сессия с навигацией

### 5. scrollPercent (entry.344881830)
- **Тип:** Целое число (0-100)
- **Описание:** Максимальный процент прокрутки страницы за всю сессию
- **Пример:** `78`, `100`, `0`
- **Расчет:** `Math.round((scrollTop / (scrollHeight - innerHeight)) * 100)`
- **Логика:** Отслеживается максимальное значение за всю сессию, отправляется только максимальное
- **Возможные значения:**
  - `0` - пользователь не прокручивал страницу
  - `1-99` - частичная прокрутка (максимальная достигнутая)
  - `100` - полная прокрутка до конца страницы

### 6. screenSize (entry.402053782)
- **Тип:** Строка (формат "ширинаxвысота")
- **Описание:** Размер видимой области экрана пользователя
- **Пример:** `1920x1080`, `375x667`, `1920x354`
- **Источник:** `window.innerWidth x window.innerHeight`

### 7. deviceType (entry.191639328)
- **Тип:** Строка
- **Описание:** Тип устройства пользователя
- **Возможные значения:**
  - `"desktop"` - настольный компьютер/ноутбук
  - `"mobile"` - мобильное устройство (телефон/планшет)
- **Логика определения:**
  1. Проверка User Agent на мобильные паттерны
  2. Проверка ширины экрана (< 800px = mobile)

### 8. browser (entry.1329174136)
- **Тип:** Строка
- **Описание:** Браузер пользователя
- **Возможные значения:**
  - `"Chrome"` - Google Chrome
  - `"Safari"` - Apple Safari
  - `"Firefox"` - Mozilla Firefox
  - `"Edge"` - Microsoft Edge
  - `"Opera"` - Opera Browser
  - `"IE"` - Internet Explorer
  - `"Other"` - другие браузеры

### 9. focusEvent (entry.2068552965)
- **Тип:** JSON-массив объектов
- **Описание:** События потери и возврата фокуса на страницу
- **Структура объекта:**
  ```json
  {
    "event": "blur|focus",
    "time": "2025-07-28T16:07:45.591Z"
  }
  ```
- **Возможные события:**
  - `"blur"` - пользователь переключился на другую вкладку/приложение
  - `"focus"` - пользователь вернулся на страницу
- **Пример:** `[]` или `[{"event":"blur","time":"..."},{"event":"focus","time":"..."}]`

## События отправки данных

### Автоматические события:
1. **beforeunload** - перед закрытием вкладки
2. **pagehide** - при переходе на другую страницу

### Ручные события (если добавить):
- Клик по кнопке "Отправить"
- Таймер (каждые N секунд)

## Технические детали

### URL отправки:
```
https://docs.google.com/forms/d/e/FORM_ID/formResponse
```

### Метод отправки:
- **sendBeacon** (предпочтительно)
- **fetch** с mode: 'no-cors' (fallback)

### Обработка ошибок:
- CORS ошибки игнорируются (нормально для Google Forms)
- Отправка происходит без ожидания ответа
- Данные отправляются даже при быстром закрытии страницы

## Примеры данных

### Типичная сессия (без кликов):
```
startTime: "2025-07-28T16:07:44.807Z"
endTime: "2025-07-28T16:07:45.578Z"
duration: 1
clickEvent: []
scrollPercent: 78
screenSize: "1920x354"
deviceType: "desktop"
browser: "Chrome"
focusEvent: []
```

### Сессия с кликом по Telegram:
```
startTime: "2025-07-28T16:07:44.807Z"
endTime: "2025-07-28T16:07:48.811Z"
duration: 4
clickEvent: [{"type":"telegram","time":"2025-07-28T16:07:48.811Z","text":"Купить через Telegram"}]
scrollPercent: 78
screenSize: "1920x354"
deviceType: "desktop"
browser: "Chrome"
focusEvent: [{"event":"blur","time":"2025-07-28T16:07:45.591Z"},{"event":"focus","time":"2025-07-28T16:07:46.012Z"}]
```

### Активная сессия с множественными кликами:
```
startTime: "2025-07-28T16:07:44.807Z"
endTime: "2025-07-28T16:07:52.123Z"
duration: 8
clickEvent: [
  {"type":"navigation","time":"2025-07-28T16:07:46.234Z","text":"О курсе"},
  {"type":"faq","time":"2025-07-28T16:07:48.456Z","text":"Нужно ли знать математику?"},
  {"type":"faq","time":"2025-07-28T16:07:50.789Z","text":"Как проходит обучение?"},
  {"type":"telegram","time":"2025-07-28T16:07:52.123Z","text":"Купить через Telegram"}
]
scrollPercent: 95
screenSize: "1920x1080"
deviceType: "desktop"
browser: "Chrome"
focusEvent: []
```

## Аналитика и интерпретация

### Метрики вовлеченности:
- **Время на странице** (duration) - чем больше, тем лучше
- **Прокрутка** (scrollPercent) - показывает интерес к контенту
- **Клики** (clickEvent) - конверсия в целевые действия
- **Потеря фокуса** (focusEvent) - отвлечение пользователя

### Сегментация аудитории:
- **Устройства** (deviceType) - мобильная vs десктопная аудитория
- **Браузеры** (browser) - техническая грамотность пользователей
- **Размер экрана** (screenSize) - качество отображения контента

## Расширение функциональности

### Дополнительные типы кликов:
- `"cta"` - клик по призыву к действию
- `"navigation"` - клик по навигации
- `"social"` - клик по социальным ссылкам
- `"contact"` - клик по контактной информации

### Дополнительные метрики:
- **Время до первого клика** - скорость принятия решения
- **Количество возвратов** - повторные посещения
- **Геолокация** - страна/город пользователя
- **Источник трафика** - откуда пришел пользователь 